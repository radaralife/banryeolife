<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반려라이프 콘텐츠 빌더 (드래그 앤 드롭 지원)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #f0f2f5;
            padding: 50px 20px;
        }

        .builder-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .builder-header {
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-item {
            padding: 30px;
            border: 1px solid #e1e4e8;
            margin-bottom: 30px;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .card-item:hover {
            border-color: #3498db;
        }

        .images-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .img-box {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .img-box.has-img {
            border-style: solid;
        }

        .img-box.has-img img {
            display: block;
        }

        .img-box.drag-over {
            border-color: #3498db;
            background: #e3f2fd;
            border-width: 3px;
        }

        .img-box .upload-prompt {
            font-size: 12px;
            color: #888;
            text-align: center;
            padding: 10px;
            pointer-events: none;
        }

        .img-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
            z-index: 10;
        }

        .img-box:hover .img-controls {
            display: flex;
        }

        .btn-mini {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
        }

        .btn-mini.rot {
            background: #2ecc71;
        }

        .btn-mini.del {
            background: #ff4757;
        }

        .card-info {
            margin-top: 20px;
        }

        .edit-year {
            display: inline-block;
            padding: 4px 15px;
            border-radius: 20px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .edit-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid transparent;
        }

        .edit-desc {
            font-size: 15px;
            color: #555;
            line-height: 1.7;
            padding: 5px;
            border-radius: 4px;
            min-height: 60px;
            border: 1px solid transparent;
        }

        .edit-title:focus,
        .edit-desc:focus {
            background: #f0f7ff;
            outline: none;
            border-color: #3498db;
        }

        .card-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-main {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-main:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .rotate-90 {
            transform: rotate(90deg) scale(0.7);
        }

        #code-output {
            margin-top: 30px;
            padding: 25px;
            background: #2d3436;
            color: #dfe6e9;
            border-radius: 12px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            display: none;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <div class="builder-container">
        <div class="builder-header">
            <div>
                <h1>시행착오 콘텐츠 빌더 <span id="save-status"
                        style="font-size: 12px; color: #2ecc71; margin-left:10px; font-weight: normal;">(자동 저장
                        중...)</span></h1>
                <p style="color: #888; font-size: 14px; margin-top: 5px;">사진을 박스로 드래그해서 넣으세요.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-danger" style="background: #95a5a6;" onclick="clearAll()">전체 삭제/초기화</button>
                <button class="btn-main" onclick="addCard()">+ 새 카드 추가</button>
            </div>
        </div>

        <div id="card-list"></div>

        <div style="text-align: center; margin-top: 40px;">
            <button class="btn-main" style="background: #2f3542; padding: 18px 40px; font-size: 16px;"
                onclick="exportCode()">최종 코드 생성하기</button>
        </div>
        <div id="code-output"></div>
    </div>

    <script>
        const STORAGE_KEY = 'banryeolife_builder_data';

        function addCard(data = null) {
            const cardId = data ? data.id : 'card-' + Date.now();
            const cardHtml = `
                <div class="card-item" id="${cardId}">
                    <div class="images-container" id="images-${cardId}">
                        <div class="img-box add-btn" 
                             onclick="addImageBox('${cardId}')"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event, '${cardId}', true)"
                             style="cursor: pointer; border: 2px dashed #3498db; background: #f0f7ff;">
                            <div class="upload-prompt" style="color: #3498db; font-weight: 700;">+ 사진 추가<br>(드래그 가능)</div>
                        </div>
                    </div>
                    
                    <div class="card-info">
                        <div class="edit-year" contenteditable="true" oninput="saveData()" style="background: ${data ? data.tagColor : '#3498db'}">${data ? data.year : '2024년'}</div>
                        <div class="edit-title" contenteditable="true" oninput="saveData()">${data ? data.title : '제목을 입력하세요'}</div>
                        <div class="edit-desc" contenteditable="true" oninput="saveData()">${data ? data.desc : '상세 내용을 입력하세요.'}</div>
                    </div>

                    <div class="card-footer">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 12px; color: #888;">태그 색상:</span>
                            <input type="color" onchange="updateTagColor('${cardId}', this.value)" value="${data ? data.tagColor : '#3498db'}">
                        </div>
                        <button class="btn-danger" style="background: #ffeaa7; color: #d63031" onclick="removeCard('${cardId}')">이 카드 삭제</button>
                    </div>
                </div>
            `;
            document.getElementById('card-list').insertAdjacentHTML('beforeend', cardHtml);

            if (data && data.images) {
                data.images.forEach(img => addImageBox(cardId, img));
            } else {
                addImageBox(cardId);
            }
            saveData();
        }

        function addImageBox(cardId, imgData = null) {
            const container = document.getElementById(`images-${cardId}`);
            const imgId = imgData ? imgData.id : 'img-' + Date.now() + Math.random().toString(36).substr(2, 5);
            const imgHtml = `
                <div class="img-box ${imgData ? 'has-img' : ''}" id="${imgId}"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, '${imgId}', false)">
                    <div class="img-controls">
                        <button class="btn-mini rot" onclick="event.stopPropagation(); rotateImg('${imgId}')">회전</button>
                        <button class="btn-mini del" onclick="event.stopPropagation(); removeImg('${imgId}')">삭제</button>
                    </div>
                    <div class="upload-prompt" style="pointer-events: none;">클릭 또는 드래그</div>
                    <img src="${imgData ? imgData.src : ''}" class="${imgData && imgData.rotated ? 'rotate-90' : ''}" onclick="event.stopPropagation(); document.getElementById('file-${imgId}').click()">
                    <input type="file" id="file-${imgId}" style="display:none" onchange="handleFile(this, '${imgId}')" accept="image/*">
                </div>
            `;
            const addBtn = container.querySelector('.add-btn');
            addBtn.insertAdjacentHTML('beforebegin', imgHtml);

            const box = document.getElementById(imgId);
            box.onclick = () => document.getElementById(`file-${imgId}`).click();
            saveData();
        }

        // --- Drag & Drop Handlers ---
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, id, isNewBox) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files && files[0] && files[0].type.startsWith('image/')) {
                if (isNewBox) {
                    // "+ 사진 추가" 버튼에 드롭한 경우 새 박스를 만들고 파일 주입
                    const newImgId = 'img-' + Date.now();
                    addImageBox(id, { id: newImgId, src: '', rotated: false });
                    processFile(files[0], newImgId);
                } else {
                    // 기존 박스에 드롭한 경우
                    processFile(files[0], id);
                }
            }
        }

        function processFile(file, imgId) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const box = document.getElementById(imgId);
                const img = box.querySelector('img');
                img.src = e.target.result;
                box.classList.add('has-img');
                saveData();
            };
            reader.readAsDataURL(file);
        }
        // ----------------------------

        function handleFile(input, imgId) {
            if (input.files && input.files[0]) {
                processFile(input.files[0], imgId);
            }
        }

        function rotateImg(imgId) {
            const img = document.querySelector(`#${imgId} img`);
            img.classList.toggle('rotate-90');
            saveData();
        }

        function removeImg(imgId) {
            document.getElementById(imgId).remove();
            saveData();
        }

        function removeCard(cardId) {
            if (confirm('이 카드를 삭제하시겠습니까?')) {
                document.getElementById(cardId).remove();
                saveData();
            }
        }

        function updateTagColor(cardId, color) {
            document.querySelector(`#${cardId} .edit-year`).style.background = color;
            saveData();
        }

        function saveData() {
            const cards = [];
            document.querySelectorAll('.card-item').forEach(cardEl => {
                const images = [];
                cardEl.querySelectorAll('.img-box.has-img').forEach(imgBox => {
                    const img = imgBox.querySelector('img');
                    images.push({
                        id: imgBox.id,
                        src: img.src,
                        rotated: img.classList.contains('rotate-90')
                    });
                });
                cards.push({
                    id: cardEl.id,
                    year: cardEl.querySelector('.edit-year').innerText,
                    title: cardEl.querySelector('.edit-title').innerText,
                    desc: cardEl.querySelector('.edit-desc').innerHTML,
                    tagColor: cardEl.querySelector('.edit-year').style.backgroundColor,
                    images: images
                });
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
            const status = document.getElementById('save-status');
            status.innerText = '(방금 저장됨)';
            setTimeout(() => { status.innerText = '(자동 저장 중...)'; }, 2000);
        }

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                const cards = JSON.parse(data);
                cards.forEach(card => addCard(card));
            } else {
                // 사용자 스토리 기반 초기 데이터 셋업
                const initialStory = [
                    {
                        id: 'story-1',
                        year: '2019년',
                        title: '아파트 복도에서의 무모한 시작',
                        desc: '사무실도 없이 아파트 복도 한켠에서 시작했습니다. 민원이 들어올까 조마조마하며 테이프를 감던 그 밤들이 반려라이프의 뿌리가 되었습니다.',
                        tagColor: '#e74c3c',
                        images: [{ id: 'img-init-1', src: 'assets/img/history/2018_start_hallway.webp', rotated: false }]
                    },
                    {
                        id: 'story-2',
                        year: '2020년',
                        title: '바닥부터 직접 일군 첫 번째 창고',
                        desc: '예산 절감을 위해 바닥 퍼티 작업부터 에폭시 도색까지 모두 셀프 작업으로 진행했습니다. 거친 바닥을 손수 메우며 성공을 확신했던 기억이 생생합니다.',
                        tagColor: '#e67e22',
                        images: [{ id: 'img-init-2', src: 'assets/img/history/2019_warehouse_start.webp', rotated: false }]
                    },
                    {
                        id: 'story-3',
                        year: '2020년',
                        title: '사다리 하나에 의지한 6m의 사투',
                        desc: '설치비를 아끼려 사다리 하나에 의지해 6m 높이의 파렛트 랙을 직접 세웠습니다. 무모했지만 그만큼 성장에 목말랐던 시절이었습니다.',
                        tagColor: '#f1c40f',
                        images: [{ id: 'img-init-3', src: 'assets/img/history/2020_warehouse_expansion.webp', rotated: false }]
                    },
                    {
                        id: 'story-4',
                        year: '2021년',
                        title: '제조업의 높은 벽과 예상치 못한 위기',
                        desc: '사료 제조업 등록까지 마쳤으나 무리한 확장과 자금 조달의 벽에 부딪혔습니다. 창고를 가득 채운 자재들을 보며 눈물의 정리를 시작해야만 했습니다.',
                        tagColor: '#d35400',
                        images: [{ id: 'img-init-4', src: 'assets/img/history/2020_inventory_struggle.webp', rotated: false }]
                    },
                    {
                        id: 'story-5',
                        year: '2023년',
                        title: '비움으로서 얻은 혁신, 선택과 집중',
                        desc: '모든 것을 직접 하려는 욕심을 버리고 잘하는 것에 집중했습니다. 물류 운영을 외주로 과감히 위임하고, 우리는 데이터와 시스템 구축에 몰입하기 시작했습니다.',
                        tagColor: '#3498db',
                        images: [{ id: 'img-init-5', src: 'assets/img/history/2023_intranet_dev.webp', rotated: false }]
                    },
                    {
                        id: 'story-6',
                        year: '2024년',
                        title: '데이터로 증명하는 스마트한 미래',
                        desc: '이제는 데이터 기반의 스마트한 시스템으로 최고의 효율을 냅니다. 우리가 겪은 모든 실패는 고객님들께 가장 합리적인 가격과 서비스를 제공하는 밑거름이 되었습니다.',
                        tagColor: '#2ecc71',
                        images: [{ id: 'img-init-6', src: 'assets/img/history/2024_advanced_ops_2.webp', rotated: false }]
                    }
                ];
                initialStory.forEach(card => addCard(card));
                saveData(); // 초기 데이터 저장
            }
        }

        function clearAll() {
            if (confirm('모든 내용을 삭제하고 초기화하시겠습니까? (복구 불가)')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function exportCode() {
            const cards = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            let resultHtml = `<!-- 생성된 코드 -->\n<div class="gallery-grid-container">\n`;
            cards.forEach(card => {
                card.images.forEach((img, idx) => {
                    resultHtml += `    <div class="history-card">
        <img src="assets/img/history/파일이름.webp" alt="${card.title}" class="${img.rotated ? 'rotate-90' : ''}">
        <div class="history-overlay">
            <span class="history-year" style="background: ${card.tagColor}">${card.year}</span>
            <div class="history-title">${card.title}</div>
            <p class="history-desc">${card.desc.replace(/<br>/g, '\n')}</p>
        </div>
    </div>\n\n`;
                });
            });
            resultHtml += `</div>`;
            document.getElementById('code-output').innerText = resultHtml;
            document.getElementById('code-output').style.display = 'block';
            document.getElementById('code-output').scrollIntoView({ behavior: 'smooth' });
        }

        window.onload = loadData;
    </script>
</body>

</html>